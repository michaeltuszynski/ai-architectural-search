name: Validate Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.9'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify imports
      run: |
        python -c "import sys; sys.path.insert(0, '.'); from config import get_config; print('âœ… Config OK')"
    
    - name: Validate deployment files
      run: |
        test -f Dockerfile && echo "âœ… Dockerfile found"
        test -f app.py && echo "âœ… app.py found"
        test -f requirements.txt && echo "âœ… requirements.txt found"
        test -f config.py && echo "âœ… config.py found"
        test -d src/ && echo "âœ… src/ directory found"
        test -d images/ && echo "âœ… images/ directory found"
        test -f image_metadata.json && echo "âœ… image_metadata.json found"
        test -f railway.json && echo "âœ… railway.json found"
        echo ""
        echo "âœ… All required files present - Railway will deploy automatically"
    
    - name: Build Summary
      if: github.ref == 'refs/heads/main'
      run: |
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Build validated successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš‚ **Railway is deploying automatically from GitHub**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check deployment status: https://railway.app/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
